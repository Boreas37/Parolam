{% extends "base.html" %}

{% block title %}Güvenli Parola Kontrolü{% endblock %}

{% block content %}
    <header>
        <h1>Parolam</h1>
        <p class="subtitle">Parolanızın veri sızıntılarında yer alıp almadığını güvenli bir şekilde kontrol edin</p>
    </header>
    
    <div class="search-container">
        <div class="search-box">
            <input type="password" id="password-input" placeholder="Parolanızı girin...">
            <button id="search-btn">Parola Kontrol Et</button>
        </div>
        <p class="info-text">Parolanız tarayıcınızdan asla ayrılmaz. Şifrelenmiş (hash) halinin sadece küçük bir ön eki kontrol için sunucuya gönderilir.</p>
    </div>
    
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value" id="email-count">Yükleniyor...</div>
            <div class="stat-label">Sızıntıya Uğrayan Hesap</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="breach-count">Yükleniyor...</div>
            <div class="stat-label">Veri Sızıntısı</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="password-count">Yükleniyor...</div>
            <div class="stat-label">Parola Hash'i</div>
        </div>
    </div>
    
    <div class="results-container" id="results-container">
        <div class="result-header">
            <div class="status-icon pwned" id="status-icon">!</div>
            <div>
                <h2 id="result-title">Parola Sızıntıya Uğramış</h2>
                <p id="result-subtitle">Bu parola veri sızıntılarında bulundu</p>
            </div>
        </div>
        
        <div id="breach-list">
            <!-- Sızıntı öğeleri buraya eklenecek -->
        </div>
    </div>
    
    <footer>
        <p>Bu, Parolam'ın bir demo sürümüdür. Son derece sınırlı bir veritabanı kullanılır.</p>
    </footer>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password-input');
    const searchBtn = document.getElementById('search-btn');
    const resultsContainer = document.getElementById('results-container');
    const resultTitle = document.getElementById('result-title');
    const resultSubtitle = document.getElementById('result-subtitle');
    const statusIcon = document.getElementById('status-icon');
    const breachList = document.getElementById('breach-list');
    
    // İstatistikleri yükle
    function loadStats() {
        fetch('/api/stats')
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    console.error('İstatistik yükleme hatası:', data.error);
                    return;
                }
                
                // Sayıları formatla
                const formatNumber = (num) => {
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num.toString();
                };
                
                document.getElementById('email-count').textContent = formatNumber(data.email_count);
                document.getElementById('breach-count').textContent = formatNumber(data.breach_count);
                document.getElementById('password-count').textContent = formatNumber(data.password_count);
            })
            .catch(err => {
                console.error('İstatistik yükleme hatası:', err);
            });
    }
    
    // Sayfa yüklendiğinde istatistikleri yükle
    loadStats();

    searchBtn.addEventListener('click', async function() {
        const password = passwordInput.value.trim();
        if (!password) {
            alert('Lütfen bir parola girin');
            return;
        }
        
        searchBtn.textContent = 'Kontrol Ediliyor...';
        searchBtn.disabled = true;
        
        try {
            // Adım 1: Tarayıcının kendi kripto fonksiyonlarını kullanarak parolayı SHA-1 ile hash'le.
            const hashBuffer = await crypto.subtle.digest('SHA-1', new TextEncoder().encode(password));
            
            // Adım 2: Oluşturulan binary hash'i okunabilir bir HEX string'e çevir.
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const fullHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
            
            // Adım 3: Hash'i 6 haneli prefix ve 34 haneli suffix olarak ikiye ayır.
            const prefix = fullHash.substring(0, 6);
            const suffix = fullHash.substring(6);
            
            console.log('DEBUG:', { password, fullHash, prefix, suffix });
            
            // Adım 4: Sunucuya SADECE prefix'i göndererek sızıntı listesini iste.
            const response = await fetch(`/check-password/${prefix}`);
            
            if (!response.ok) {
                throw new Error(`Sunucu hatası: ${response.status} ${response.statusText}`);
            }
            const data = await response.text();
            
            console.log('DEBUG: API Response:', data);
            
            // Adım 5: Sunucudan gelen listede kendi suffix'imizi (hash'in geri kalanını) ara.
            const pwnedData = findSuffixInList(data, suffix);
            console.log('DEBUG: Pwned Data:', pwnedData);
            displayPasswordResult(pwnedData);

        } catch (error) {
            console.error('DEBUG: Error:', error);
            displayPasswordResult({ error: 'Bir hata oluştu: ' + error.message });
        } finally {
            searchBtn.textContent = 'Parola Kontrol Et';
            searchBtn.disabled = false;
        }
    });

    // Bu fonksiyon, sunucudan gelen metin listesini satır satır işler.
    function findSuffixInList(list, suffixToFind) {
        console.log('DEBUG: findSuffixInList called with:', { list, suffixToFind });
        
        if (!list) { // Sunucudan boş yanıt gelirse
            console.log('DEBUG: Empty list received');
            return { pwned: false };
        }
        const lines = list.split('\r\n');
        console.log('DEBUG: Split lines:', lines);
        
        for (const line of lines) {
            console.log('DEBUG: Checking line:', line);
            const parts = line.split(':'); // "SUFFIX:COUNT" formatını ayır
            console.log('DEBUG: Line parts:', parts);
            
            if (parts.length === 2 && parts[0] === suffixToFind) {
                // Eşleşme bulundu!
                const count = parseInt(parts[1], 10);
                console.log('DEBUG: Match found!', { suffix: parts[0], count });
                return { pwned: true, count: count };
            }
        }
        
        console.log('DEBUG: No match found');
        return { pwned: false };
    }

    // Sonucu kullanıcıya gösteren fonksiyon.
    function displayPasswordResult(data) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
        
        if (data.error) {
            statusIcon.textContent = '!';
            statusIcon.className = 'status-icon pwned';
            resultTitle.textContent = 'Hata';
            resultSubtitle.textContent = data.error;
            breachList.innerHTML = '';
        } else if (data.pwned) {
            statusIcon.textContent = '!';
            statusIcon.className = 'status-icon pwned';
            resultTitle.textContent = 'Parola sızıntıya uğramış!';
            resultSubtitle.textContent = `Bu parola, bilinen veri sızıntılarında en az ${data.count.toLocaleString('tr-TR')} kez görülmüş`;
            breachList.innerHTML = '<p>Bu parolayı başka hiçbir yerde kullanmadığınızdan emin olun ve hemen değiştirin!</p>';
        } else {
            statusIcon.textContent = '✓';
            statusIcon.className = 'status-icon safe';
            resultTitle.textContent = 'Parola güvende';
            resultSubtitle.textContent = 'Bu parola bilinen sızıntılarımızda bulunamadı';
            breachList.innerHTML = '<p>Bu parola bilinen sızıntılarımızda bulunamadı.</p>';
        }
    }
    
    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBtn.click();
        }
    });
});
</script>
{% endblock %}